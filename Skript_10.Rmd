# Chi-Quadrat-Tests

## Lernziele dieser Sitzung

Sie können...

- einen $\chi^2$-Unabhängigkeitstest durchführen.
- einen $\chi^2$-Anpassungstest durchführen.

## Anwendungsbereich

In [Sitzung 9](#bivariate-verteilungen-mit-nominalen-variablen) haben wir gelernt, wie für bivariate Verteilungen Korrelationen beschrieben werden können, wenn beide Variablen nominalskaliert sind. Grundlage dafür waren die Häufigkeiten von Wertekombinationen in der Kreuztabelle.

Auch für $\chi^2$-Tests sind beobachtete Häufigkeiten in einer Kreuztabelle unser Ausgangspunkt. Wir fragen jedoch nicht nach einem Kennwert für die Stärke der Korrelation, sondern wollen wissen, ob es einen statistisch signifikanten Zusammenhang zwischen den beiden Variablen gibt -- also einen Zusammenhang, der nur mit einer Wahrscheinlichkeit $\alpha$ zufällig zustande gekommen ist.

Um den Unterschied zu verdeutlichen: Bei sehr großen Fallzahlen kann auch eine leichte Korrelation statistisch signifikant sein, bei kleinen Fallzahlen wird es es selbst für starke Korrelationen schwierig, eine statistische Signifikanz nachzuweisen.

Mit dem $\chi^2$-Unabhängigkeitstest und dem $\chi^2$-Anpassungstest lernen wir im Folgenden zwei leicht unterschiedliche Varianten des $\chi^2$-Tests kennen. Beide sollen direkt an Beispielen ausgeführt werden.

## $\chi^2$-Unabhängigkeitstest

Grundlage sind bivariate Häufigkeiten, die in einer Kreuztabelle dargestellt werden können (s. \@ref(tab:zivi1)). Wie Kreuztabellen erstellt werden, haben wir bereits in [Sitzung 9](#kreuztabelle) behandelt.

```{r zivi1}
crosstable <- function(x, format, sums=T, expected=F, chisq=F, varnames=T, row.order=NULL, col.order=NULL, caption=NULL, df.only=F){
  sink("nul")
  xt <- gmodels::CrossTable(x[,1],x[,2], expected = T)
  sink()
  ts <- ""
  chisq.contribs <- c()
  if(is.null(row.order)){row.order <- rownames(xt$t)}
  if(is.null(col.order)){col.order <- colnames(xt$t)}
  first.col <- row.order
  if(format=="latex") {
    nbsp <- "~"
  } else {
    nbsp <- "&nbsp;"
  }
  col.names <- c(ifelse(varnames, paste0(colnames(x)[1], nbsp, "$\\downarrow$"), ""), col.order)
  if (format == "latex"){
    building <- list(
        begin_cell = "\\makecell[tr]{",
        end_cell = "}",
        begin_expected = "(",
        end_expected = ")",
        begin_chisq = "\\textcolor{goethe_blue}{",
        end_chisq = "}",
        linebreak = "\\\\"
      )
  } else if (format == "html") {
    if(is.numeric(expected)) {
      begin_expected <- sprintf('<span class="fragment" data-fragment-index=%s>(', expected)
    } else {
      begin_expected <- "<span>("
    }
    if(is.numeric(chisq)) {
       begin_chisq = sprintf('<span class="blue-text fragment" data-fragment-index=%s>', chisq)
    } else {
      begin_chisq = "<span class='blue-text'>"
    }
    building = list(
      begin_cell = "",
      end_cell = "",
      begin_expected = begin_expected,
      end_expected = ")<span>",
      begin_chisq = begin_chisq,
      end_chisq = "</span>",
      linebreak = "<br>"
    )
  } else { stop("Invalid format.") }
  kable.out <- function(df){
    kable.params <- list(
      x = df,
      format = format,
      align = "r",
      escape = F)
    if(format=="latex"){
      kable.params$booktabs = T
      kable.params$longtable = F
    }
    if(!is.null(caption)) kable.params$caption=caption
    k <- do.call(kable, kable.params)
    if(varnames){
      header.above <- c(1,2)
      if(sums) header.above <- c(header.above, 1)
      header.names <- c(" ", colnames(x)[2])
      if(sums) header.names <- c(header.names, " ")
      names(header.above) <- header.names
      k <- k %>%
               add_header_above(header = header.above, line = F) %>%
               column_spec(1, border_right = T)
    }
    if(format == "html"){
      return(k %>%
             column_spec(1, extra_css = "background:var(--sand_gray); color:var(--goethe_blue);font-weight:600") %>%
             row_spec(nrow(xt$t)+1, bold = T) %>%
             column_spec(ncol(xt$t)+2, bold=T))
    }
    if(sums){
      k <- k %>%
        column_spec(1 + ncol(xt$t), border_right = T) %>%
        row_spec(nrow(xt$t), hline_after = T)
    }
    return(k %>%
             column_spec(1, border_right=T) %>%
             kable_styling())
  }
  for(row in row.order){
    for(col in col.order){
      obs <- xt$t[row,col]
      exp <- round(xt$chisq$expected[row,col],2)
      chisq.contrib <- round((obs-exp)^2/exp,3)
      chisq.contribs <- c(chisq.contribs, chisq.contrib)
      ts <- paste0(ts, building$begin_cell, obs )
      if(expected){ ts <- paste0(ts, building$linebreak, building$begin_expected, format(exp, nsmall=2), building$end_expected)}
      if(chisq){ ts <- paste0(ts, building$linebreak, building$begin_chisq, format(chisq.contrib,nsmall=3), building$end_chisq)}
      ts <- paste0(ts, building$end_cell, "|")
    }
    if(sums){ts <- paste0(ts, sum(xt$t[row,]))}
    ts <- paste0(ts, "
")
  }
  if(sums){
    for(col in col.order){
      ts <- paste0(ts, sum(xt$t[,col]),"|")
    }
    ts <- paste0(ts, sum(xt$t))
    col.names <-c(col.names, "")
    first.col <- c(first.col, "")
  }
  df <- cbind(data.frame(first.col), read.table(text = ts, stringsAsFactors = F, quote = "", sep="|"))
  colnames(df) <- col.names
  if(df.only){
    return(df)
  } else {
    return(list(df=kable.out(df), contrib=chisq.contribs))
  }
}

zivi <- read.table("img/10_zivi_dt")
zivixt <- crosstable(zivi, format="html", varnames = F, caption = "Kreuztabelle der Beispieldaten")
zivixt$df
```

Unser Beispieldatensatz beschäftigt sich mit Kriegsdienstverweigerern. Zwischen 1956 und 2011 galt in der BRD die Wehrpflicht, d.h. alle vom Staat als "männlich" erfassten und als "tauglich" gemusterte jungen Menschen mussten Dienst an der Waffe leisten -- es sei denn, sie verweigerten den Kriegsdienst und leisteten stattdessen Zivildienst (z.B. in sozialen Einrichtungen).

Zusätzlich zur Frage der Kriegsdienstverweigerung sei in einer Zufallsstichprobe von als tauglich gemusterten erhoben, ob der Wohnort eine Gemeinde mit über oder unter 20000 Einwohner\*innen ("Stadt" oder "Land") ist.^[Hier wird also eine verhältnisskalierte Variable (Bevölkerungszahl der Gemeinde) in eine nominalskalierte Variable transformiert. In Fällen wie diesen, wo die Variable nach der Transformation nur zwei Werte annehmen kann, sprechen wir auch von der "Dichotomisierung" einer Variable.] Die Ergebnisse sind in \@ref(tab:zivi1) zusammengefasst.

Wir interessieren uns für den statistischen Zusammenhang dieser beiden Variablen, und zwar möchten wir die Hypothese prüfen, dass Menschen aus der Stadt eher den Kriegsdienst verweigerten als Menschen vom Land. Der Test wird entlang der bekannten sechs Schritte ausgeführt.

### Test wählen und Voraussetzungen prüfen

Für den $\chi^2$-Unabhängigkeitstest müssen folgende Voraussetzungen erfüllt sein:

- Ziel ist die Überprüfung einer bivariaten Verteilung auf einen statistisch signifikanten Zusammenhang zwischen zwei nominalskalierten Variablen.
- Grundlage sind beobachtete Häufigkeiten aus einer einfachen, unabhängigen Zufallsstichprobe.
- Alle Tabellenfelder enthalten beobachtete Häufigkeiten $(n_{ij}\geq 5)$.

Für unsere Beispieldaten sind diese Voraussetzungen gegeben.

### Hypothesen formulieren

Wir haben wieder zwei Möglichkeiten: die gerichtete und die ungerichtete Alternativhypothese.

#### Ungerichtete Alternativhyptothese

Wir verzichten an dieser Stelle auf mathematische Notationen und würden bei ungerichteter Alternativhypothese im Klartext schreiben:

\[\begin{aligned}
H_0 &: \textrm{Es gibt keinen Zusammenhang zwischen Wohnort und Verweigerungsentscheidung.}\\
H_1 &: \textrm{Es gibt einen Zusammenhang zwischen Wohnort und Verweigerungsentscheidung.}
\end{aligned}\]

#### Gerichtete Alternativhyptothese

Im Falle einer gerichteteten Alternativhypothese bleibt die Nullhypothese bestehen, aber die Alternativhypothese gibt eine bestimmte Richtung des Zusammenhangs vor.

\[\begin{aligned}
H_0 &: \textrm{Es gibt keinen Zusammenhang zwischen Wohnort und Verweigerungsentscheidung.}\\
H_1 &: \textrm{Es gibt einen positiven Zusammenhang zwischen Wohnort in der Stadt} \\
&\quad\textrm{und Kriegsdienstverweigerung.}
\end{aligned}\]

Gerichtete Alternativhypothesen sind im $\chi^2$-Unabhängigkeitstest *nur* für $2\times2$-Tabellen möglich.

Im Beispiel entscheiden wir uns für die gerichtete Alternativhypothese, denn wir vermuten einen Zusammenhang in diese bestimmte Richtung.

### Signifikanzniveau entscheiden

Wie in anderen Tests ist ein Signifikanzniveau von $\alpha=0,05$ üblich, wofür wir uns auch im Beispiel entscheiden.

### Kritischen Wert bestimmen

Bei $\chi^2$-Tests gibt es immer nur einen kritischen Wert. Zunächst müssen beim $\chi^2$-Unabhängigkeitstest die Freiheitsgrade bestimmt werden mit der Formel:

\[\mathit{df} = (k - 1) \cdot (\ell - 1)
(\#eq:dfu)\]

wobei auch hier wieder $k$ für die Zeilenanzahl und $\ell$ für die Spaltenanzahl steht.

Im Beispiel also:

\[\begin{aligned}
\mathit{df} &= (k - 1) \cdot (\ell - 1)\\
&=(2-1)\cdot (2 - 1) = 1
\end{aligned}\]

Damit lässt sich der kritische Wert aus der [Formelsammlung](Formelsammlung und Wertetabellen.pdf) ablesen, die allerdings für *ungerichtete* Alternativhypothesen ausgelegt ist.

Hätten wir eine ungerichtete Alternativhypothese gewählt, würde der Ablehnungsbereich also definiert durch:

\[\begin{aligned}
\chi^2 &\geq \chi^2_{df;(1-\alpha)}\\
\chi^2 &\geq \chi^2_{1;95\%}\\
\chi^2 &\geq 3,841
\end{aligned}\]

Für unsere gerichtete Alternativhypothese "dürfen" wir den Ablehnungsbereich jedoch verdoppeln (müssen aber im nächsten Schritt auch prüfen, ob die Richtung auch stimmt):

\[\begin{aligned}
\chi^2 &\geq \chi^2_{df;(1-2\cdot\alpha)}\\
\chi^2 &\geq \chi^2_{1;90\%}\\
\chi^2 &\geq 2,706
\end{aligned}\]

### Prüfgröße berechnen

Wie in [Sitzung 9](#berechnung-des-kontingenzkoeffizenten-chi2) besprochen, wird die Prüfgröße $\chi^2$ anhand der Formel

\[
\chi^2= \sum_{i=1}^{k}\sum_{j=1}^{\ell}\frac{(n_{ij}-m_{ij})^{2}}{m_{ij}}
(\#eq:chisq)
\]

errechnet. Dabei ist die Ermittlung der Erwartungswerte $m_{ij}$ ein notwendiger Schritt, und auch die Teilwerte für $\chi^2$ können wieder direkt in die Kreuztabelle eingetragen werden.

```{r zivi2, fig.pos='H'}
zivixt <- crosstable(zivi, format="html", varnames = F, expected = T, chisq = T, caption = "Kreuztabelle mit Erwartungswerten und Teilwerten für $\\chi^2$")
zivixt$df
```

Für unser Beispiel erfolgt die Berechnung anhand \@ref(tab:zivi2).

Zunächst muss dabei geprüft werden, ob die Richtung unserer Alternativhypothese stimmt. Die beobachtete Häufigkeit der Zivildienstleistenden in der Stadt $n_{22}=23$ ist größer als der Erwartungswert $m_{22}=18,1$. Wenn eine Signifikanz nachgewiesen werden kann, dann also für den *positiven* Zusammenhang zwischen Wohnort in der Stadt und Kriegsdienstverweigerung (wie in unserer Alternativhypothese spezifiziert).

Für $\chi^2$ ergibt sich im Beispiel:

\[\begin{aligned}
\chi^2 &= \sum_{i=1}^{k}\sum_{j=1}^{\ell}\frac{(n_{ij}-m_{ij})^{2}}{m_{ij}}\\[4pt]
&=1,833+1,51+1,611+1,327\\
&=6,281
\end{aligned}\]

### Ergebnis interpretieren

Der Wert der Prüfgröße $\chi^2=6,281$ liegt deutlich im Ablehnungsbereich $\chi^2\geq 2,706$. Die Nullhypothese kann abgelehnt werden. Es wurde ein statistisch signifikanter positiver Zusammenhang zwischen Wohnort in Gemeinden mit über 20000 Einwohner\*innen und Kriegsdienstverweigerung festgestellt ($\alpha=0,05$).

\begin{rtip}
In R lässt sich ein $\chi^2$-Unabhängigkeitstest mit dem Befehl {\tt chisq.test()} durchführen.
\end{rtip}

## $\chi^2$-Anpassungstest

Beim $\chi^2$-Anpassungsest geht es um die Häufigkeiten *eines* nominalskalierten Merkmals -- er ist deshalb der univariaten Teststatistik zuzuordnen. Der Test überprüft, ob das Merkmal entlang einer vorgegebenen Verteilung (im Normalfall gleichmäßig) verteilt ist, oder ob es signifikante Abweichungen von dieser erwarteten Verteilung gibt.

Ein Beispiel: Für größere Verspätungen ($\geq$ 10 Minuten) beim ÖPNV einer Großstadt wird festgehalten, an welchen Wochentagen sie auftreten. Wir ignorieren Wochenden und Feiertage und fragen uns, ob sich die Verzögerungen gleichmäßig auf Werktage verteilen, oder ob es signifikante Abweichungen in Bezug auf den Wochentag gibt. Die Werte in \@ref(tab:late) seien über drei Monate hinweg erhoben worden.

```{r late}
read.table(sep="|", header=T, text = "
Wochentag  | Häufigkeit
Montag     |        459
Dienstag   |        409
Mittwoch   |        414
Donnerstag |        387
Freitag    |        437
") %>% kable("html", escape=F, caption="Häufigkeiten größerer Verspätungen im ÖPNV")
```


Wir befolgen wieder die sechs Schritte für statistische Testverfahren.

### Test wählen und Voraussetzungen prüfen

Für den $\chi^2$-Anpassungstest müssen folgende Voraussetzungen erfüllt sein:

- Ziel ist die Überprüfung einer nominalskalierten Variable auf eine statistisch signifikante Abweichung von einer vorgegebenen Verteilung.
- Grundlage sind beobachtete Häufigkeiten aus einer einfachen, unabhängigen Zufallsstichprobe.
- Alle Tabellenfelder enthalten beobachtete Häufigkeiten $(n_{i}\geq 5)$.

In unserem Beispiel sind diese Voraussetzungen gegeben.

### Hypothesen formulieren

\[\begin{aligned}
H_0 &: \textrm{Starke Verspätungen sind an allen Werktagen gleich wahrscheinlich.}\\
H_1 &: \textrm{Starke Verspätungen sind an manchen Wertkagen wahrscheinlicher als an anderen.}
\end{aligned}\]

Gerichtete Hypothesen dürfen hier nur bei dichotomen Variablen formuliert werden (also bei zwei Tabellenfeldern).

### Signifikanzniveau entscheiden

Üblich: $\alpha=0,05$

### Kritischen Wert bestimmen

Die Freiheitsgrade bestimmen sich aus

\[\mathit{df}=k-1
(\#eq:dfe)\]

wobei $k$ hier einfach die Anzahl der Katorien ist.

In unserem Beispiel (bei fünf Werktagen) also:

\[\begin{aligned}
\mathit{df}&=k-1\\
&=5-1=4
\end{aligned}\]

Der kritische Wert für den Ablehnungsbereich ist der [Formelsammlung](Formelsammlung und Wertetabellen.pdf) zu entnehmen.

\[\begin{aligned}
\chi^2 &\geq \chi^2_{\mathit{df};(1-\alpha)}\\
\chi^2 &\geq \chi^2_{4;95\%}\\
\chi^2 &\geq 9,488
\end{aligned}\]

Auch hier wäre bei einer gerichteten Hypothese der kritische Wert $\chi^2_{\mathit{df};(1-2\cdot \alpha)}$ anzuwenden -- dies ist allerdings wie bereits erwähnt nur für dichotome Variablen möglich.

### Prüfgröße berechnen

Die Prüfgröße $\chi^2$ berechnet sich analog zu vorherigen Beispielen. Einzige Besonderheit: Die Erwartungswerte werden direkt anhand der zu erwartenden (im Regelfall: gleichmäßigen) Verteilung bestimmt.

Im Beispiel ergibt sich in den fünf Kategorien jeweils ein Erwartungswert von

\[\frac{n}{k}=\frac{2106}{5}=421,2\]

```{r xtlate}
options(knitr.kable.NA = '')
read.table(sep="|", header=T, text = "
       |          |          |            |         |
459    | 409      | 414      | 387        | 437     | 2106
(421,2)| (421,2)  | (421,2)  | (421,2)    | (421,2) | 
3,392  | 0,353    | 0,123    |  2,777     | 0,593   | 
") %>%
  kable("html", escape=F, longtable=F, col.names=c("Montag", "Dienstag", "Mittwoch", "Donnerstag", "Freitag", " "), caption = "Tabelle für den $\\chi^2$-Anpassungstest") %>%
  column_spec(5, border_right = T) %>%
  row_spec(3, color = "#00618F")
```

Dann nehmen wir wieder eine Tebelle zu Hilfe um die Prüfgröße $\chi^2$ zu berechnen (s. \@ref(tab:xtlate)). Wie gehabt werden einfach die Teilwerte zusammengezählt:

\[\begin{aligned}
\chi^2 &= \sum_{i=1}^{k}\frac{(n_{i}-m_{i})^{2}}{m_{i}}\\[4pt]
&=3,392 +  0,353 +  0,123 +  2,777 + 0,593\\
&=7,238
\end{aligned}\]

### Ergebnis interpretieren

Der Ablehnungsbereich $\chi^2 \geq 9,488$ wurde nicht erreicht. Die Nullhypothese muss beibehalten werden. Eine statistisch signifikante Abweichung von einer gleichmäßigen Verteilung konnte nicht nachgewiesen werden ($\alpha=0,05$).

\begin{rtip}
Mit einer univariaten Verteilung als Eingabe führt der Befehl {\tt chisq.test()} einen $\chi^2$-Anpassungstest durch.
\end{rtip}

### Andere Verteilungen

Die theoretische Verteilung, von der eine signifikante Abweichung festgestellt werden soll, ist im obigen Beispiel uniform, d.h. gleichmäßig. Allerdings kann beim Anpassungstest auch von anderen Verteilungen ausgegangen werden -- so könnte eine (begründete) Nullhypothese auch lauten, dass Kategorie A doppelt so viele Fallzahlen aufweist wie Kategorie B und C.

In der Praxis wird der $\chi^2$-Anpassungstest auch oft verwendet, um nachzuweisen, dass *keine* signifikante Abweichung von der Normalverteilung zu beobachten ist -- nur dann dürfen nämlich viele statistische Verfahren durchgeführt werden.

## Aufgaben

### Aufgabe 1

Sie interessieren sich dafür, ob in einem Unternehmen der Tätigkeitsbereich mit dem Geschlecht der Angestellten zusammenhängt.

In den Personalakten sind Angestellte als "männlich" oder "weiblich" erfasst und ihre Tätigkeitsfelder in "Leitende Tätigkeit", "Administration" und "Fertigung" unterteilt.

Folgende Häufigkeiten sind erfasst:

```{r}
firma <- read.table("img/10_firma_dt")
#firmaxt <- crosstable(firma, "latex", sums=F, varnames = F, col.order = c("Leitende Tätigkeit", "Administration", "Fertigung"))
#firmaxt$df
```

a) Welchen Test führen Sie durch?
b) Formulieren Sie die Hypothesen.
c) Das Thema wird in der Unternehmensleitung bereits kontrovers diskutiert, weshalb Sie einen Fehler 1. Art zu 99% ausschließen möchten. Wie lautet das Signifikanzniveau?
d) Bestimmen Sie die Freiheitsgrade und den kritischen Wert.
e) Berechnen Sie die Prüfgröße.
f) Wie interpretieren Sie das Ergebnis?

### Aufgabe 2

Eine Ihner Bekannten behauptet, dass beim Elfmeterschießen -- "statistisch gesehen" -- in 60% der Fälle das Team gewinnt, das zuerst den Strafstoß ausführt.

Sie möchten das empirisch überprüfen und schauen sich in Archiven siebzig Partien bei Fußballturnieren an, die durch Elfmeterschießen entschieden wurden. Tatsächlich stellen Sie fest, dass in genau 60% der Fälle das zuerst ausführende Team gewann.

Prüfen Sie, ob diese Beobachtung auch statistisch relevant ist. Wählen Sie 5% als Signifikanzniveau.

## Tipps zur Vertiefung

- Kapitel 9 in @bortz
- Kapitel 5.3.4 in @bahrenberg
- Kapitel 13 in @klemm

\pagebreak

## Quellen
